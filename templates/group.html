{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold text-primary">{{ group.name }}</h3>
  </div>

  <div class="row g-4">
    
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Tasks</h5>
        </div>
        <div class="card-body">
          <ul class="list-group" id="task-list">
            {% for t in tasks %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ t.title }}</span>
              <input type="checkbox" class="form-check-input task-checkbox" data-task-id="{{ t.id }}" {% if t.completed %}checked{% endif %}>
            </li>
            {% endfor %}
          </ul>

          {% if current_user.role=='manager' %}
          <form id="task-form" class="mt-3 d-flex gap-2">
            <input id="task-title" class="form-control" placeholder="New task..." required>
            <button class="btn btn-success"><i class="bi bi-plus-circle"></i> Add</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>Group Chat</h5>
        </div>
        <div class="card-body d-flex flex-column" style="height: 400px;">
          <div id="chat-box" class="border rounded p-2 mb-2 flex-grow-1 overflow-auto bg-light">
            {% for msg in messages %}
            <div class="p-2 mb-1 rounded {% if msg.sender_id == current_user.id %}bg-primary text-white text-end{% else %}bg-white{% endif %}">
              <strong>
                {% for u in members %}
                  {% if u.id == msg.sender_id %}
                    {{ u.username }}
                  {% endif %}
                {% endfor %}
              </strong>: {{ msg.content }}
            </div>
            {% endfor %}
          </div>

          <form id="chat-form" class="d-flex gap-2 mt-auto">
            <input id="chat-input" class="form-control" placeholder="Type a message..." required>
            <button class="btn btn-primary"><i class="bi bi-send"></i></button>
          </form>

          {% if current_user.role == 'developer' and not current_user_in_group %}
          <button id="joinBtn" class="btn btn-warning mt-2">Request to Join Group</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
var socket = io();
var username = "{{ current_user.username }}";
var userId = {{ current_user.id }};
var groupId = {{ group.id }};


socket.emit('join', {username: username, group_id: groupId});


document.getElementById('chat-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const content = document.getElementById('chat-input').value.trim();
  if (!content) return;
  socket.emit('send_message', {username, user_id: userId, group_id: groupId, content});
  document.getElementById('chat-input').value = '';
});

socket.on('receive_message', (data)=>{
  const chatBox = document.getElementById('chat-box');
  const div = document.createElement('div');
  const isSelf = data.sender === username;
  div.className = `p-2 mb-1 rounded ${isSelf ? 'bg-primary text-white text-end' : 'bg-white'}`;
  div.innerHTML = `<strong>${data.sender}</strong>: ${data.content}`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
});

function attachTaskToggle(cb) {
  cb.addEventListener('change', ()=>{
    fetch("/task/toggle", {
      method: "POST",
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `task_id=${cb.dataset.taskId}`
    });
  });
}
document.querySelectorAll('.task-checkbox').forEach(cb => attachTaskToggle(cb));

{% if current_user.role == 'manager' %}
document.getElementById('task-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const title = document.getElementById('task-title').value.trim();
  if (!title) return;
  fetch("/task/create", {
    method: "POST",
    headers: {'Content-Type':'application/x-www-form-urlencoded'},
    body: `title=${encodeURIComponent(title)}&group_id=${groupId}`
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      const taskList = document.getElementById('task-list');
      const li = document.createElement('li');
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `${title} <input type="checkbox" class="form-check-input task-checkbox" data-task-id="${data.task_id}">`;
      taskList.prepend(li);
      attachTaskToggle(li.querySelector('.task-checkbox'));
      document.getElementById('task-title').value = '';
    }
  });
});
{% endif %}


socket.on('task_created', (t)=>{
  if (t.group_id === groupId) {
    const taskList = document.getElementById('task-list');
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `${t.title} <input type="checkbox" class="form-check-input task-checkbox" data-task-id="${t.id}">`;
    taskList.prepend(li);
    attachTaskToggle(li.querySelector('.task-checkbox'));
  }
});

socket.on('task_toggled', (t)=>{
  if (t.group_id === groupId) {
    const cb = document.querySelector(`.task-checkbox[data-task-id='${t.id}']`);
    if (cb) cb.checked = t.completed;
  }
});


const joinBtn = document.getElementById('joinBtn');
if(joinBtn){
  joinBtn.addEventListener('click', ()=>{
    fetch('/group/join', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ group_id: groupId })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.msg);
      if(data.ok){
        joinBtn.style.display = 'none';
      }
    })
    .catch(err => console.error('Error:', err));
  });
}
</script>
{% endblock %}
